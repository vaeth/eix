#! /usr/bin/env sh

project="eix"
mkclean="./mksvnclean"
mkemerge="./mkemerge"
mkrelease="./mkrelease"
mkmake="./mkmake"
mkmakeextra="UPDATEPOFILES="
make_opts='-0OQEeq'

export LC_ALL XZ_OPT
LC_ALL=C
XZ_OPT='--extreme'

Echo () {
	printf '%s\n' "${*}"
}

Usage () {
	Echo "Usage: ${0##*/} [options] [xz|lzma|bzip2|gzip|default]
options: -fakeroot, -fakeroot-ng, -no-fakeroot (default is -${fakeroot})"
	exit ${1:-1}
}

Die () {
	printf '%s: %s\n' "${0##*/}" "${1}"
	exit ${2:-1}
}

Run () {
	Echo "${*}"
	"${@}" || Die "${*} failed" ${?}
}

dist='dist'
fakeroot=''
[ -z "${fakeroot}" ] && command -v fakeroot >/dev/null 2>&1 && fakeroot='fakeroot'
[ -z "${fakeroot}" ] && command -v fakeroot-ng >/dev/null 2>&1 && fakeroot='fakeroot-ng'

while [ ${#} -gt 0 ]
do	opt="${1#-}"
	opt="${opt#-}"
	case "${opt#dist-}" in
		x*|X*) dist='dist-xz';;
		l*|L*) dist='dist-lzma';;
		b*|B*) dist='dist-bzip2';;
		g*|G*) dist='dist-gzip';;
		d*|D*) dist='dist';;
		f*ng) fakeroot='fakeroot-ng';;
		f*) fakeroot='fakeroot';;
		F*|n*f*) fakeroot='';;
		help|h|H|'?') Usage 0;;
		*) Usage;;
	esac
	shift
done
[ -z "${dist}" ] && Usage

if [ -n "${mkclean}" ]
then test -e Makefile || test -e configure || test -e Makefile.in \
	&& test -e "${mkclean}" && Run "${mkclean}"
fi

unset LDFLAGS CFLAGS CXXFLAGS
if [ -n "${fakeroot}" ] && command -v "${fakeroot}" >/dev/null 2>&1
then	Run ${mkmake} ${make_opts}n
	docmd="${fakeroot} ${mkmake} ${make_opts}r"
else	docmd="${mkmake} ${make_opts}"
fi
for i in ${dist}
do	Run ${docmd} ${mkmakeextra} "${i}"
done

found=false
for j in tar.xz tar.lzma tar.bz2 tar.gz zip tar.Z shar.gz shar
do	for i in "${PWD}/${project}"-*".${j}"
	do	test -f "${i}" || continue
		${found} || Echo "Available tarballs:"
		found=:
		printf '\t%s\n' "${i}"
	done
done
${found} || Die "For some reason no tarball was created"
[ -n "${mkclean}" ] && Echo "The tarballs will be removed with ${mkclean}"
[ -n "${mkemerge}" ] && Echo "To install with portage run as root ${mkemerge}"
[ -n "${mkrelease}" ] && \
	Echo "To tag the release in svn you should run ${mkrelease}"
exit 0
